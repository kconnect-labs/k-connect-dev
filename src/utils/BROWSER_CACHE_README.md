# Система кеширования на основе стандартного кеша браузера

## Описание

Новая система кеширования использует стандартные возможности браузера для кеширования медиа файлов (изображения, бейджи, аватары). Это решение намного проще и надежнее, чем IndexedDB.

## Основные преимущества

1. **Простота** - использует встроенные возможности браузера
2. **Надежность** - нет проблем с IndexedDB на разных устройствах
3. **Производительность** - быстрая загрузка из кеша браузера
4. **Совместимость** - работает на всех устройствах одинаково

## Как работает

1. **Загрузка файла**: Сначала проверяется кеш браузера, если файл не найден - загружается с сервера
2. **Кеширование**: Файл сохраняется в памяти приложения и создается blob URL для немедленного использования
3. **Очистка**: Автоматическая очистка устаревших файлов каждые 10 минут

## Использование

### Базовое использование

```typescript
import { browserCache } from '../utils/browserCache';

// Получить файл из кеша
const cachedUrl = await browserCache.getFile('/static/uploads/image.jpg');

// Загрузить и закешировать файл
const url = await browserCache.loadFile('/static/uploads/image.jpg');

// Проверить наличие файла в кеше
const exists = await browserCache.hasFile('/static/uploads/image.jpg');
```

### Использование хука

```typescript
import { useUnifiedCache } from '../hooks/useUnifiedCache';

const MyComponent = () => {
  const { loadFile, getFile, isLoading, error } = useUnifiedCache();
  
  const handleLoadImage = async () => {
    const url = await loadFile('/static/uploads/image.jpg');
    // Использовать url для отображения изображения
  };
  
  return (
    <div>
      {isLoading && <div>Загрузка...</div>}
      {error && <div>Ошибка: {error}</div>}
      <button onClick={handleLoadImage}>Загрузить изображение</button>
    </div>
  );
};
```

## Настройки

- **CACHE_DURATION**: 7 дней (время жизни кеша)
- **MAX_CACHE_SIZE**: 1000 записей (максимальное количество файлов)
- **MAX_CACHE_SIZE_MB**: 500MB (максимальный размер кеша)

## Поддерживаемые форматы

- **Изображения**: .jpg, .jpeg, .png, .webp, .bmp, .tiff, .gif, .ico, .avif
- **Векторная графика**: .svg
- **Исключены**: видео (.mp4, .avi, .mov, .webm, .mkv), аудио (.mp3, .wav, .ogg, .m4a)

## Автоматическая очистка

Система автоматически очищает:
- Устаревшие файлы (старше 7 дней)
- Избыточные файлы (при превышении лимитов)
- Самые большие файлы (при превышении размера кеша)

## Статистика кеша

```typescript
const stats = await browserCache.getCacheStats();
console.log(`Кеш: ${stats.count} файлов, ${stats.sizeMB}MB`);
```

## Очистка кеша

```typescript
// Очистить конкретный файл
await browserCache.clearFileCache('/static/uploads/image.jpg');

// Очистить весь кеш
await browserCache.clearCache();
```

## Миграция с IndexedDB

Все компоненты уже обновлены для использования новой системы:
- `ImageGrid.tsx` - кеширование изображений в постах
- `Badge.js` - кеширование бейджей
- `OptimizedImage.js` - кеширование оптимизированных изображений
- `postUtils.ts` - утилиты для работы с изображениями
- `CacheManagementModal.tsx` - управление кешем в настройках

## Решение проблем

### Проблема: Изображения показываются на секунду, потом идет анимация загрузки

**Решение**: Новая система использует `cache: 'force-cache'` в fetch запросах, что заставляет браузер использовать свой кеш. Это решает проблему с "миганием" изображений.

### Проблема: На ПК работает по-другому, чем на мобильных

**Решение**: Стандартный кеш браузера работает одинаково на всех устройствах, в отличие от IndexedDB.

### Проблема: CORS ошибки

**Решение**: Используются правильные заголовки и режим `cors` для загрузки файлов.

## Производительность

- **Загрузка из кеша**: ~1-5ms
- **Загрузка с сервера**: зависит от размера файла и скорости интернета
- **Использование памяти**: контролируется лимитами (500MB максимум)
- **Очистка**: автоматическая каждые 10 минут
