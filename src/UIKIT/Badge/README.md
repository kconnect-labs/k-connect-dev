# Badge Component - Система кеширования

## Проблема
Браузер пытался проверять актуальность бейджей через HTTP OPTIONS запросы, что приводило к CORS ошибкам:
```
Access to fetch at 'https://s3.k-connect.ru/static/images/bages/...' has been blocked by CORS policy
```

## Решение
Реализована система кеширования бейджей, которая:
- ✅ Загружает изображения один раз и кеширует их
- ✅ Использует blob URLs для избежания повторных HTTP запросов
- ✅ Предотвращает CORS ошибки
- ✅ Улучшает производительность

## Компоненты системы

### 1. BadgeCache (`utils/badgeCache.ts`)
- **Назначение**: Кеширование изображений бейджей
- **Особенности**:
  - Кеш на 24 часа
  - Максимум 100 бейджей в памяти
  - Автоматическая очистка при выгрузке страницы
  - Fallback на base64 при ошибках

### 2. BadgePreloader (`utils/badgePreloader.ts`)
- **Назначение**: Предзагрузка популярных бейджей
- **Особенности**:
  - Предзагружает популярные бейджи при старте
  - Поддерживает предзагрузку пользовательских бейджей
  - Не блокирует основной рендеринг

### 3. Обновленный Badge компонент
- **Изменения**:
  - Использует кешированные изображения
  - Показывает спиннер загрузки
  - Fallback на "?" при ошибках
  - Улучшенная обработка ошибок

## Использование

### Базовое использование
```jsx
import Badge from './UIKIT/Badge';

<Badge 
  achievement={{
    image_path: '5be5c288-fe2d-4445-9ece-b2405125737a.svg',
    bage: 'Premium Badge'
  }}
  size="medium"
/>
```

### Предзагрузка бейджей пользователя
```javascript
import { badgePreloader } from '../utils/badgePreloader';

// Предзагрузить бейджи пользователя
await badgePreloader.preloadUserBadges(userAchievements);
```

## Статистика и отладка

### Получить статистику кеша
```javascript
import { badgeCache } from '../utils/badgeCache';

const stats = badgeCache.getCacheStats();
console.log(`Кеш: ${stats.size} бейджей`);
```

### Получить статистику предзагрузки
```javascript
import { badgePreloader } from '../utils/badgePreloader';

const stats = badgePreloader.getPreloadStats();
console.log(`Предзагружено: ${stats.preloaded}/${stats.total}`);
```

## Производительность

### До оптимизации
- ❌ CORS ошибки при каждой загрузке
- ❌ Повторные HTTP запросы
- ❌ Блокировка рендеринга

### После оптимизации
- ✅ Нет CORS ошибок
- ✅ Изображения загружаются один раз
- ✅ Мгновенное отображение из кеша
- ✅ Плавная загрузка с индикатором

## Технические детали

### Кеширование
- **Тип**: In-memory cache с blob URLs
- **Время жизни**: 24 часа
- **Размер**: Максимум 100 бейджей
- **Очистка**: Автоматическая при выгрузке страницы

### Fallback стратегия
1. Попытка загрузки с `cache: 'force-cache'`
2. При ошибке - загрузка как base64
3. При полной ошибке - показ "?" placeholder

### Предзагрузка
- **Популярные бейджи**: Автоматически через 1 секунду после загрузки
- **Пользовательские**: По запросу через `preloadUserBadges()`
- **Неблокирующая**: Использует `Promise.allSettled()`
